<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>My Page</title>
  <!-- Google Maps Script -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9mkeIzzI2qWMgheafMWpuzRIASK9U05g&libraries=places,geometry&v=weekly&callback=initMap" async defer></script>
  <script src="/js/jquery-3.7.1.min.js"></script>
  <script src="js/mypage.js"></script>
  <link rel="stylesheet" href="css/mypage_stlye.css">
</head>
<body>
  <div id="container">
    <div id="header">
      <h2>My page</h2>
    </div>
    <div id="body">
      <!--지도 영역 -->
      <div id="map"></div>
      <!--후기 영역-->
      <!--검색창-->
      <div class="search_frame">
        <div class="search_area">
          <input id="address_search" type="text" placeholder="주소 또는 장소를 검색하세요">
        </div>
      </div>
        <form>
          <ul class="review_list">
            <!--후기 작성시 동적 li 추가-->
          </ul>
        </form>
      </div>
    </div>
    <!--footer-->
  </div>
  
<script>
  let map;
  let marker;
  let labelIndex = 1;//마커라벨
  let markers = []; // 마커를 저장할 배열
  let addr;
  
  //구글맵 api
  async function initMap() {
    // 초기 맵 설정 (서울 시청 좌표 기준 예시)
    const initialLocation = { lat: 37.5665, lng: 126.9780 };
    map = new google.maps.Map(document.getElementById("map"), {
      center: initialLocation,
      zoom: 16,
    });

    //주소값 호출
    const geocoder = new google.maps.Geocoder();
    const infowindow = new google.maps.InfoWindow();
    
    //주소검색
    const serach_input = document.getElementById("address_search");
    const autocomplete = new google.maps.places.Autocomplete(serach_input, {
        fields: ["geometry", "name", "formatted_address"]
      });

    autocomplete.addListener("place_changed",()=>{
      const place = autocomplete.getPlace();
      //위치정보 없을시
      if (!place.geometry || !place.geometry.location) {
        alert("해당 장소의 위치 정보를 찾을 수 없습니다.");
        return;
      }

      //맵 중앙으로 줌
      map.setCenter(place.geometry.location);
      map.setZoom(17);

      // 검색한 위치에 임시 마커 표시
      const search_marker = new google.maps.Marker({
        position: place.geometry.location,
        map: map,
        animation: google.maps.Animation.DROP,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: "#4285F4",
          fillOpacity: 0.8,
          strokeColor: "#ffffff",
          strokeWeight: 2
        }
      });
    });
    
    //맵 클릭시 마커 생성
    google.maps.event.addListener(map, "click", async function(event) {
      // 좌표
      const lat = event.latLng.lat().toFixed(5);
      const lng = event.latLng.lng().toFixed(5);
      const latLng = event.latLng;
      const currentIndex = labelIndex;

      marker = new google.maps.Marker({
        position: latLng,
        map: map,
        animation: google.maps.Animation.DROP,
        label: '',
        draggable:true,
      });
      markers.push(marker);

      setTimeout(() => {
        marker.setLabel(String(currentIndex));
      }, 500);
      labelIndex++; 

      //주소 가져오기
      let address = "";
      let addressComponents = [];

      //역지오코딩(좌표 -> 주소)
      try{
        const addr_result = await geocoder.geocode({location:latLng});
        if(addr_result.results[0]){
          address = addr_result.results[0].formatted_address;
          addressComponents = addr_result.results[0].address_components;
        }
      }catch(e){
        address = "주소 없음";
      }
      addr = address;

      //장소명 가져오기
      let place_name = "";
      try{
        //placeService 객체
        const service = new google.maps.places.PlacesService(map);
        place_name = await new Promise((resolve) => {
          service.nearbySearch({
            location:latLng,
            radius: 5, //반경 5미터
          },
          (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
              console.log("nearbySearch results:", results);
              let bestPlace = null;
              let minDistance = null;

              for(let place of results){
                const types = place.types || [];
                const name = place.name;
                //제외할 키워드
                const ban_types = ['country','political'];
                const has_ban_type = types.some(ban_type => ban_types.includes(ban_type));
                const ban_name = ['대한민국', 'South Korea', '구', '동'];
                const has_ban_name = ban_name.some(banned => place.name.includes(banned));
                
                if (!has_ban_type && !has_ban_name && name && name !== address) {
                  //좌표와 근처 거리 계산
                  const placeLocation = place.geometry.location;
                  const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    latLng,
                    placeLocation
                  );
                  
                  //console.log(`Place: ${name}, Distance: ${distance.toFixed(2)}m, Types:`, types);
                  
                  // 10미터 이내의 가장 가까운 장소
                  if (distance < 5 && (minDistance === null || distance < minDistance)) {
                    minDistance = distance;
                    bestPlace = { name, distance };
                    //console.log("best_place : "+bestPlace);
                  }else {
                    // nearbySearch 실패 시 주소에서 동/가 이름 추출
                    // const sublocality = addressComponents.find(comp =>
                    //   comp.types.includes('sublocality_level_4') ||
                    //   comp.types.includes('sublocality_level_3') ||
                    //   comp.types.includes('sublocality_level_2')
                    // );
                    // resolve(sublocality ? sublocality.long_name : "");
                  }
                }
              }
              if(bestPlace){
                resolve(bestPlace.name);
              }else {
                // 적절한 장소를 못 찾으면 주소에서 동/가 이름 추출
                // const sublocality = addressComponents.find(comp =>
                //   comp.types.includes('sublocality_level_4') ||
                //   comp.types.includes('sublocality_level_3') ||
                //   comp.types.includes('sublocality_level_2')
                // );
                // resolve(sublocality ? sublocality.long_name : "");
              }
            }else{
              resolve("");
            }
          });
        });
      }catch(e){
        console.error("장소명 검색 오류:", e);
        const sublocality = addressComponents.find(comp =>
          comp.types.includes('sublocality_level_2')
        );
        place_name = sublocality ? sublocality.long_name : "";
      }
      

    //li 템플릿 생성
    const $li = $(`
      <li>
        <div class="card">
          <div class="card_head">
            <div class="card_title">
              <h3>
                <!--${labelIndex-1}-->
                <input type="text" name="tr_subject" id="tr_subject_${lat}_${lng}" class="tr_subject" value="${place_name}"></h3>
              <div class="addr_area">
                <input type="text" name="tr_addr" id="tr_addr_${lat}_${lng}" class="tr_addr" value="${address}" disabled>
              </div>
            </div>
            <div class="expend_btn_area">
              <button type="button">
                <img src="img/icon/down.png" width="40">
              </button>
            </div>
          </div>
          <div class="card_body off">
            <div class="content_write_area">
              <form class="tr_starForm" autocomplete="off">
                <div>
                  <strong>별점</strong>
                  <div class="tr_starBox" role="radiogroup" aria-label="별점 선택">
                    <button type="button" data-val="1">★</button>
                    <button type="button" data-val="2">★</button>
                    <button type="button" data-val="3">★</button>
                    <button type="button" data-val="4">★</button>
                    <button type="button" data-val="5">★</button>
                    <input type="hidden" name="rating" class="tr_ratingVal" value="0">
                  </div>
                </div>
              </form>
              <div class="text_area_box">
                <textarea class="text_area" rows="6"></textarea>
              </div>
              <div class="file_area">
                      <label for="file_upload_${lat}_${lng}" class="file_label" multiple>
                        <img src="img/icon/input_icon.png" alt="업로드 버튼 이미지" width="10px">
                        <!-- <span>파일첨부</span> -->
                      </label>
                      <input type="file" id="file_upload_${lat}_${lng}" class="file_upload" multiple>
              </div>
              <div class="write_btn_area btn">
                <button type="button">작성</button>
                <button type="reset">취소</button>
              </div>
            </div>
          </div>
        </div>
      </li>
    `);
     // review_list에 append
      $(".review_list").append($li);
        });
    //});
  }
  
  window.onload = initMap;
</script>



</body>
</html>